# Design Document: Snapshot Testing Utility for JUnit XML Files

## Overview

This document outlines the design for a snapshot testing utility written in Rust that will track changes to test results over time. The utility will specifically process JUnit XML files generated by pytest while testing C code, and will follow a workflow pattern similar to the `insta` crate.

## Goals

- Create a Rust-based utility that can parse and process JUnit XML files
- Track changes in test results over time using snapshots
- Provide a workflow similar to `insta` for reviewing and accepting changes
- Support integration with CI/CD pipelines
- Make it easy to identify regressions or improvements in C code tests

## Background

### JUnit XML Format

JUnit XML is a standard format for test results that includes:
- Test suite information
- Individual test case results
- Execution time
- Error and failure information
- System output

### Insta Workflow

The `insta` crate provides a workflow where:
1. Tests generate output
2. Output is compared against stored snapshots
3. Differences are highlighted
4. Users can review and accept changes using a CLI tool

## System Design

### Core Components

1. **XML Parser**
   - Parse JUnit XML files into structured data
   - Extract relevant test information

2. **Snapshot Manager**
   - Store and retrieve snapshots
   - Compare current results with stored snapshots
   - Generate diff reports

3. **CLI Interface**
   - Commands for reviewing changes
   - Commands for accepting/rejecting changes
   - Options for filtering and formatting output

4. **Configuration System**
   - Project-specific settings
   - Ignore patterns
   - Custom comparison settings

### Data Model

```rust
/// Represents a test suite from JUnit XML
struct TestSuite {
    name: String,
    tests: u32,
    failures: u32,
    errors: u32,
    skipped: u32,
    time: f64,
    timestamp: String,
    test_cases: Vec<TestCase>,
}

/// Represents an individual test case
struct TestCase {
    name: String,
    classname: String,
    time: f64,
    status: TestStatus,
    failure_message: Option<String>,
    failure_type: Option<String>,
    system_out: Option<String>,
    system_err: Option<String>,
}

/// Status of a test case
enum TestStatus {
    Success,
    Failure,
    Error,
    Skipped,
}

/// Snapshot of test results
struct Snapshot {
    id: String,
    timestamp: DateTime<Utc>,
    test_suites: Vec<TestSuite>,
}

/// Difference between snapshots
struct SnapshotDiff {
    old_snapshot: Option<Snapshot>,
    new_snapshot: Snapshot,
    added_tests: Vec<TestCase>,
    removed_tests: Vec<TestCase>,
    changed_tests: Vec<(TestCase, TestCase)>,
    status_changes: Vec<StatusChange>,
}

/// Change in test status
struct StatusChange {
    test_name: String,
    old_status: TestStatus,
    new_status: TestStatus,
}
```

## Implementation Plan

### Phase 1: Core Functionality

1. **JUnit XML Parser**
   - Implement parser using `quick-xml` or similar crate
   - Create data structures for test suites and cases
   - Add validation for XML format

2. **Snapshot Storage**
   - Design snapshot file format in JSON
   - Implement serialization/deserialization
   - Create directory structure for snapshots

3. **Basic Comparison Logic**
   - Implement algorithms to compare test results
   - Generate detailed diffs between snapshots
   - Highlight important changes (e.g., passing → failing)

### Phase 2: CLI Interface

1. **Command Structure**
   - `init`: Initialize snapshot directory
   - `capture`: Create new snapshots from JUnit XML files
   - `check`: Compare current results with snapshots
   - `review`: Interactive review of changes
   - `accept`: Accept changes to snapshots

2. **Output Formatting**
   - Color-coded terminal output
   - Summary statistics
   - Detailed test case information

3. **Filtering Options**
   - Filter by test name/pattern
   - Filter by status change
   - Filter by test suite

### Phase 3: Advanced Features

1. **CI Integration**
   - GitHub Actions

2. **Reporting**
   - HTML report generation
   - Trend analysis
   - Performance tracking over time

3. **Configuration System**
   - Project-specific settings
   - Ignore patterns for noisy tests
   - Custom comparison thresholds

## File Structure

```
src/
├── main.rs                 # Entry point
├── cli/                    # CLI implementation
│   ├── mod.rs
│   ├── commands.rs
│   └── output.rs
├── junit/                  # JUnit XML parsing
│   ├── mod.rs
│   ├── parser.rs
│   └── model.rs
├── snapshot/               # Snapshot management
│   ├── mod.rs
│   ├── storage.rs
│   ├── diff.rs
│   └── review.rs
└── config/                 # Configuration
    ├── mod.rs
    └── settings.rs
```

## Dependencies

- `clap`: Command line argument parsing
- `quick-xml`: XML parsing
- `serde`: Serialization/deserialization
- `chrono`: Date and time handling
- `similar`: Text diffing
- `colored`: Terminal coloring
- `dialoguer`: Interactive CLI prompts
- `anyhow`: Error handling

## Example Usage

```bash
# Initialize snapshot directory
snapshot-tool init

# Capture snapshots from JUnit XML files
snapshot-tool capture --input test-results/*.xml

# Check current results against snapshots
snapshot-tool check --input test-results/*.xml

# Review changes interactively
snapshot-tool review

# Accept all changes
snapshot-tool accept --all
```

## Configuration File Example

```toml
# snapshot.toml
[general]
snapshot_dir = ".snapshots"
junit_pattern = "test-results/*.xml"

[review]
show_output = true
show_system_err = false

[filters]
ignore_patterns = [
    "test_flaky_.*",
    "test_experimental_.*"
]

[diff]
context_lines = 3
```

## Testing Strategy

1. **Unit Tests**
   - Test XML parsing with various JUnit formats
   - Test snapshot comparison logic
   - Test CLI argument parsing

2. **Integration Tests**
   - End-to-end workflow tests
   - Test with real JUnit XML files

3. **Property-Based Tests**
   - Generate random test suites and verify comparison logic

## Future Enhancements

1. **Performance Metrics**
   - Track test execution time trends
   - Identify slow tests

2. **Multi-Project Support**
   - Compare results across multiple projects
   - Aggregate statistics

3. **Plugin System**
   - Custom formatters
   - Integration with other testing frameworks

4. **Web Interface**
   - Browser-based review of changes
   - Dashboard for test trends

## Conclusion

This snapshot testing utility will provide a robust way to track changes in C code test results over time. By following the workflow pattern of the `insta` crate and focusing on JUnit XML files, it will offer a familiar and efficient experience for developers while helping to identify regressions quickly.
