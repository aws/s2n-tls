name: Build Dashboard

on:
  schedule:
    - cron: 0 10,16 * * *
  issues:
    types: [opened, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Check out GitHub Pages branch
        uses: actions/checkout@v2
        with:
          ref: 'gh-pages'

      - name: 'Generate Dashboard'
        uses: ethomson/issue-dashboard@v1
        with:
          config: |
            title: s2n-tls Dashboard
            description: |
              Issues and PRs for s2n-tls
            output:
              format: html
              filename: dashboard/index.html
            sections:
            - title: 'Issues stats'
              description: 'Queries of open issues by their creation date.'
              widgets:
              - type: 'graph'
                title: 'Age'
                elements:
                - title: '7 days'
                  issue_query: 'repo:aws/s2n-tls is:open is:issue created:>{{ date("-7 days") }}'
                  color: 'green'
                - title: '90 days'
                  issue_query: 'repo:aws/s2n-tls is:open is:issue created:{{ date("-90 days") }}..{{ date("-7 days") }}'
                  color: 'yellow'
                - title: '>1 years'
                  issue_query: 'repo:aws/s2n-tls is:open is:issue created:<{{ date("-365 days") }}'
                  color: 'red'

            - title: 'Issues needing comments'
              description: 'Issues with no comments'
              widgets:
              - type: 'number'
                title: 'Needing Comments'
                issue_query: 'repo:aws/s2n-tls is:open is:issue comments:0 -label:s2n-core'
                color: 'yellow'

            - title: 'Pull Requests'
              widgets:
              - type: 'number'
                title: 'Needs Review'
                issue_query: 'repo:aws/s2n-tls is:open is:pr review:none -label:status/stale -label:s2n-core'
                color: 'red'
              - type: 'number'
                title: 'PRs with changes requested'
                issue_query: 'repo:aws/s2n-tls is:open is:pr review:changes_requested sort:created-asc -label:status/stale'
                color: 'red'
              - type: 'number'
                title: 'PRs with zero interactions'
                issue_query: 'repo:aws/s2n-tls is:open is:pr interactions:0 sort:created-asc -label:status/stale -label:s2n-core'
                color: 'blue'
              - type: 'table'
                title: 'Oldest Pull Requests without Review'
                fields:
                - title: 'Issue'
                  property: 'number'
                - title: 'Date'
                  value: '{{ date(item.created_date) }}'
                - title: 'Title'
                  property: 'title'
                issue_query: 'repo:aws/s2n-tls is:open is:pr review:none sort:created-asc'
                limit: 15
          token: ${{ github.token }}

      - name: Publish Documentation
        run: |
          git add .
          git config user.name 'GitHub Actions'
          git config user.email 'nobody@github.com'
          git commit -m 'Dashboard update' --allow-empty
          git push origin gh-pages
