name: "CodeQL"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: "1 18 * * 0"

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ c, python ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality
          query-filters:
           - exclude:
                      id: cpp/bad-strncpy-size
                      id: cpp/certificate-not-checked
                      id: cpp/cgi-xss
                      id: cpp/cleartext-storage-buffer
                      id: cpp/cleartext-storage-file
                      id: cpp/command-line-injection
                      id: cpp/external-entity-expansion
                      id: cpp/incorrect-allocation-error-handling
                      id: cpp/insufficient-key-size
                      id: cpp/missing-check-scanf
                      id: cpp/non-https-url
                      id: cpp/path-injection
                      id: cpp/pointer-overflow-check
                      id: cpp/potential-system-data-exposure
                      id: cpp/resource-not-released-in-destructor
                      id: cpp/return-stack-allocated-memory
                      id: cpp/signed-overflow-check
                      id: cpp/sql-injection
                      id: cpp/system-data-exposure
                      id: cpp/tainted-format-string
                      id: cpp/tainted-format-string-through-global
                      id: cpp/tainted-permissions-check
                      id: cpp/unbounded-write
                      id: cpp/uncontrolled-allocation-size
                      id: cpp/uncontrolled-arithmetic
                      id: cpp/uncontrolled-process-operation
                      id: cpp/unsafe-strncat
                      id: cpp/unsafe-use-of-this
                      id: cpp/user-controlled-bypass
                      id: cpp/using-expired-stack-address

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2
        if: ${{ matrix.language == 'c' || matrix.language == 'python' }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{ matrix.language }}"
