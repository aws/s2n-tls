# It looks like valgrind may generate false positives on pthreads: https://stackoverflow.com/a/13132968
{
   pthread_false_positive
   Memcheck:Leak
   match-leak-kinds: possible
   fun:calloc
   fun:allocate_dtv
   fun:_dl_allocate_tls
   fun:allocate_stack
   fun:pthread_create@@GLIBC_2.2.5
   fun:main
}
# Append valgrind suppression for ubuntu22 and ubuntu24
# If this suppression is not include, Test number 82, 95,113, 121, and 158 will fail
# This block is the same suppression as the pthread suppressions above, but for a diffeent libC.
# Adding tracking issue #4777. Remove the previous pthread suppressions block after new Ctest memcheck is fully integrated.
{
   pthread_false_positive_ubuntu22
   Memcheck:Leak
   match-leak-kinds: possible
   fun:calloc
   fun:calloc
   fun:allocate_dtv
   fun:_dl_allocate_tls
   fun:allocate_stack
   fun:pthread_create@@GLIBC_2.34
   ...
   fun:main
}
# This suppression is to suppress backtrace() memory defects for Ubuntu22 and 24.
# backtrace are loaded dynamically when they were first used, and dynamic loading will call malloc.
# Those allocated memory are not subsequently freed in Ubuntu22 and 24's libC.
# https://man7.org/linux/man-pages/man3/backtrace_symbols_fd.3.html
{
   stacktrace_suppression
   Memcheck:Leak
   match-leak-kinds: possible
   fun:malloc
   fun:malloc
   fun:_dlfo_mappings_segment_allocate
   fun:_dl_find_object_update_1
   fun:_dl_find_object_update
   fun:dl_open_worker_begin
   fun:_dl_catch_exception
   fun:dl_open_worker
   fun:_dl_catch_exception
   fun:_dl_open
   fun:do_dlopen
   fun:_dl_catch_exception
   fun:_dl_catch_error
   fun:dlerror_run
   fun:__libc_dlopen_mode
   fun:__libc_unwind_link_get
   fun:__libc_unwind_link_get
   fun:backtrace
   ...
   fun:main
}
# TODO: fix the pedantic leak errors from s2n_fork_generation_number_test
{
   ignore_s2n_fork_generation_number_test
   Memcheck:Leak
   match-leak-kinds: reachable
   ...
   fun:s2n_test_case_default_cb
   fun:main
}
{
   ignore_s2n_fork_generation_number_test
   Memcheck:Leak
   match-leak-kinds: reachable
   ...
   fun:s2n_test_case_madv_wipeonfork_cb
   fun:main
}
