---
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"). You may not use
# this file except in compliance with the License. A copy of the License is
# located at
#
# http://aws.amazon.com/apache2.0/
#
# or in the "license" file accompanying this file. This file is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied. See the License for the specific language governing permissions and
# limitations under the License.
version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      # Install Rust dependencies
      - ./codebuild/bin/install_ubuntu_dependencies.sh
      - source $HOME/.cargo/env
      - rustup toolchain install stable
      - rustup override set stable
      - cargo install cargo-criterion
      
      # Install Python dependencies
      - sudo apt install python3.12-venv
      - python3 -m venv .venv
      - source .venv/bin/activate
      - pip3 install "boto3[crt]"

  pre_build:
    commands:
      - cd bindings/rust/extended
      - ./generate.sh --skip-tests
      - cd $CODEBUILD_SRC_DIR

  build:
    commands:
      - cd bindings/rust/standard/benchmarks
      - cargo criterion --message-format json > criterion_output.log
      - cd $CODEBUILD_SRC_DIR

  post_build:
    commands:
      - |
        python3 .github/bin/criterion_to_cloudwatch.py \
          --criterion_output_path bindings/rust/standard/benchmarks/criterion_output.log \
          --namespace s2n-tls-bench \
          --platform Linux-X64
